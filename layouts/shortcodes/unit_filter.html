{{ $file := $.Get 0 }}
{{ $faction := $.Get 1 }}

{{ if not $file }}
  {{ errorf "The unit_filter shortcode requires a path to the JSON file in the data directory. See %s" .Position }}
{{ end }}

{{ if not $faction }}
  {{ errorf "The unit_filter shortcode requires a second parameter specifying the faction name. See %s" .Position }}
{{ end }}

{{ $dataPath := split $file "/" }}
{{ $data := .Site.Data }}

{{ range $dataPath }}
  {{ if isset $data . }}
    {{ $data = index $data . }}
  {{ else }}
    {{ errorf "Could not find %s in data path %s. See %s" . $file $.Position }}
  {{ end }}
{{ end }}

{{ $filteredUnits := dict }}

{{ range $unitKey, $unitData := $data }}
  {{ if and (isset $unitData "EraZero") (reflect.IsSlice $unitData.EraZero) }}
    {{ $hasOwnership := false }}
    {{ range $index, $owner := $unitData.EraZero }}
      {{ if eq $owner $faction }}
        {{ $hasOwnership = true }}
      {{ end }}
    {{ end }}
    {{ if $hasOwnership }}
      {{ $filteredUnits = merge $filteredUnits (dict $unitKey $unitData) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if gt (len $filteredUnits) 0 }}
  <!-- <h3>Units owned by {{ $faction }} ({{ len $filteredUnits }} found)</h3> -->
  {{ range $unitKey, $unitData := $filteredUnits }}

  <table id="{{ $unitKey }}" class="units-table">
    <h3 class="unit-title">
      <a id="#{{ $unitKey }}" href="#{{ $unitKey }}">
        {{ if isset $unitData "LocalizedName" }}{{ $unitData.LocalizedName }}{{ else }}{{ $unitKey }}
        {{ end }}
      </a>
    </h3>
    <tbody>
        <tr>
          {{/*  Unit Image  */}}
          <td class="unit-image">
            {{ $imagePath := printf "/info_cards/%s_info.webp" $unitData.Dictionary | lower }}
            <img src="{{ $imagePath | relURL }}" alt="{{ $unitData.Dictionary }} Info">
          </td>

{{/*  Unit information  */}}
<td class="unit-info">
  <table class="attribute-table">
    <tr>
      <th>Soldiers</th>
      <td>
        {{ if isset $unitData "SoldierCount" }}
          {{ printf "%.0f" (mul $unitData.SoldierCount 2.5) }}
        {{ else }}
          N/A
        {{ end }}
      </td>
    </tr>
    <tr>
      <th>Attack</th>
      <td>{{ if isset $unitData "PriAttack" }}{{ $unitData.PriAttack }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Charge Bonus</th>
      <td>{{ if isset $unitData "PriCharge" }}{{ $unitData.PriCharge }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Weapon Type</th>
      <td>{{ if isset $unitData "PriWeaponType" }}{{ $unitData.PriWeaponType | title }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Total Defense</th>
      <td>{{ if and (isset $unitData "PriDefense") (isset $unitData "PriArmour") (isset $unitData "PriShield") }}
        {{ $priDef := int $unitData.PriDefense }}
        {{ $secDef := int $unitData.PriArmour }}
        {{ $priShield := int $unitData.PriShield }}
        {{ add (add $priDef $secDef) $priShield }}
          {{ else }}N/A{{ end }}
      </td>
    </tr>
    <tr>
      <th>Armour</th>
      <td>{{ if isset $unitData "PriArmour" }}{{ $unitData.PriArmour }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Defence Skill</th>
      <td>{{ if isset $unitData "PriDefense" }}{{ $unitData.PriDefense }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Shield</th>
      <td>{{ if isset $unitData "PriShield" }}{{ $unitData.PriShield }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Hitpoints</th>
      <td>{{ if isset $unitData "HitPoints" }}{{ $unitData.HitPoints }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Recruitment Cost</th>
      <td>{{ if isset $unitData "RecruitCost" }}{{ $unitData.RecruitCost }}{{ else }}N/A{{ end }}</td>
    </tr>
    <tr>
      <th>Upkeep</th>
      <td>{{ if isset $unitData "Upkeep" }}{{ $unitData.Upkeep }}{{ else }}N/A{{ end }}</td>
    </tr>
  </table>
</td>

        </tr>
    </tbody>
  </table>
  <p class="unit-desc">
    {{/* Description */}}
    {{ if isset $unitData "Descr" }}{{ $unitData.Descr | replaceRE "\\\\n" "<br>" | safeHTML }}{{ else }}N/A{{ end }}
  </p>
  <br>
  <hr>
  <br>
  {{ end }}
{{ else }}
  <div class="notice">No units found for faction "{{ $faction }}"</div>
{{ end }}